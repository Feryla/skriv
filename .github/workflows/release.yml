name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target universal-apple-darwin
          - platform: ubuntu-22.04
            args: ''
          - platform: windows-latest
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20

      - name: Setup Rust stable
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install Apple certificate (macOS)
        if: matrix.platform == 'macos-latest'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Generate changelog
        id: changelog
        run: |
          tag="${{ github.ref_name }}"
          prev=$(git describe --tags --abbrev=0 "$tag^" 2>/dev/null || echo "")
          if [ -n "$prev" ]; then
            log=$(git log --pretty=format:"- %s" "$prev..$tag" -- . ':!.github')
          else
            log=$(git log --pretty=format:"- %s" "$tag" -- . ':!.github')
          fi
          {
            echo 'body<<EOF'
            echo "$log"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        timeout-minutes: 30
        uses: tauri-apps/tauri-action@73fb865345c54760d875b94642314f8c0c894afa # v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'skriv ${{ github.ref_name }}'
          releaseBody: ${{ steps.changelog.outputs.body }}
          releaseDraft: true
          prerelease: false
          includeUpdaterJson: true
          args: ${{ matrix.args }}

  updater-json:
    name: Fix updater signatures
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Rebuild latest.json from .sig files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ github.ref_name }}"
          repo="${{ github.repository }}"

          # Download latest.json generated by tauri-action
          gh release download "$tag" --repo "$repo" --pattern 'latest.json' --output latest.json

          # For each platform entry, replace the signature with the actual .sig file
          for url in $(jq -r '.platforms[].url' latest.json | sort -u); do
            filename=$(basename "$url")
            sigfile="${filename}.sig"

            gh release download "$tag" --repo "$repo" --pattern "$sigfile" --output "$sigfile" 2>/dev/null || continue

            sig=$(tr -d '\n' < "$sigfile")

            jq --arg url "$url" --arg sig "$sig" \
              '.platforms |= with_entries(if .value.url == $url then .value.signature = $sig else . end)' \
              latest.json > latest.tmp && mv latest.tmp latest.json
          done

          # Re-upload with correct signatures
          gh release upload "$tag" latest.json --clobber --repo "$repo"

  sbom:
    name: Generate SBOM
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20

      - name: Setup Rust stable
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Install frontend dependencies
        run: npm ci

      - name: Generate JS SBOM (CycloneDX)
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom-js.cdx.json

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx

      - name: Generate Rust SBOM (CycloneDX)
        working-directory: src-tauri
        run: cargo cyclonedx --format json

      - name: Upload SBOMs to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.ref_name }} sbom-js.cdx.json src-tauri/app.cdx.json --clobber
